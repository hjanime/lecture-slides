---
title: 生物统计原理
author: "王强"
institute: "南京大学生命科学学院"
date: \today{}
toc: true

---

```{r setup, include=FALSE}
# load packages
library(knitr)
library(tidyverse)
library(lubridate)
library(survival)
library(survminer)

# set output options
knitr::opts_chunk$set(fig.width = 4, fig.height = 3, dpi=300)
options(digits = 4)
```

```{bash compile, include=FALSE}
# Rscript -e "library(knitr); knitr::knit('biostat-survival.rmd');"
# make biostat-survival

```


# 生存分析

## 生存数据

对于癌症

* Overall survival (OS)
  * Time from surgery to death
* Progression-free survival (PFS)
  * Time from start of treatment to progression, Time to progression (TTP)
  * Time from response to recurrence

# Kaplan--Meier plot

## Basic Kaplan--Meier plot

Let's start by creating some basic data. We have 10 patients "at risk", with a follow-up of 10
months. Every participant gets an identical treatment.


```{r scenario1, warning=F, echo=F, message=F, comment=NA}
followup <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
eventtype <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1)

patientID <- c("John", "Jess", "Ann", "Mary", "Frank", "Steven", "Andy", "Elizabeth", "Joe", "Kate")
scenario <- c("A", "A", "A", "A", "A", "A", "A", "A", "A", "A")

toy_dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(toy_dataset) <- c("PatientID", "Followup", "Eventtype", "Scenario")

kable(toy_dataset)

```

\note{

If we take a closer look at the 'Follow-up' and 'Eventtype' columns:

* Follow-up time can be any time-interval: days, months, years.
* Event type of 1 equals an event (for example death in an overall survival study)
* Event type of 0 equals a right-censored event.

}

In this first example, there are no censored events.

---

Every month, 1 participant has an event (in an overall survival study this would be death). Every
time an event occurs, the survival probability drops by 0.1 of the remaining curve (= #events / #at
risk = $\frac{1}{10}$ of the remaining curve at month 1, $\frac{1}{9}$ of the remaining curve at
month 2 and so on):

```{r basicplot, warning=F, echo=F, message=F}
# We can plot this table with the `survival` and `survminer` packages.
# First, we define what the time column is (`toy_dataset$Followup`) and the event column is (`toy_dataset$Eventtype`).
# Afterwards, we can fit the Kaplan Meier curve to this data (`survfit(surv_object ~ Scenario)`).
# Note that in this simulation we are showing multiple scenarios, so we are fitting to `toy_dataset$Scenario`, but this can also be for example a treatment column.
surv_object <- Surv(time = toy_dataset$Followup , event = toy_dataset$Eventtype)
fit1 <- survfit(surv_object ~ Scenario, data = toy_dataset)
j <- ggsurvplot(fit1, data = toy_dataset, xlim = c(0,11), conf.int = FALSE,  risk.table = "nrisk_cumcensor", legend.title = " ", tables.theme = theme_cleantable(), break.time.by = 2,risk.table.fontsize = 4 ,risk.table.height = 0.20, censor.shape = c("|"), censor.size = 6)

j$plot <- j$plot +
  scale_x_continuous(breaks = sort(c(seq(0, 10, 1)))) +
  scale_y_continuous(breaks = sort(c(seq(0, 1, 0.1))))
j

```

## Kaplan Meier plot with censored data

```{r scenario2, warning=F, echo=F, message=F, comment=NA}
followup <- c(1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10)
eventtype <- c(1, 1,  0, 0, 1, 1, 1, 0, 1, 0)

toy_dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(toy_dataset) <- c("PatientID", "Followup", "Eventtype", "Scenario")

kable(toy_dataset)

```

---

```{r basicplot2, ref.label='basicplot', warning=F, echo=F, message=F}
```


## Importance of confidence intervals

Especially when there are very few patients at risk, the impact of a censored event can have a big
impact on the appearance of the KM curve.

In the previous plot, it seems that the survival curve reaches a plateau at 0.2 surival probability
(curve A). If we would swap the censored status between Joe and Kate (participants 9 and 10), the KM
curve changes drastically and drops to 0 at the end of the study period. In this scenario (curve B),
all participants either had an event or were censored.


```{r scenario3, warning=F, echo=F, message=F, comment=NA}
followup <- c(1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10, 1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10)
eventtype <- c(1, 1,  0, 0, 1, 1, 1, 0, 1, 0, 1, 1,  0, 0, 1, 1, 1, 0, 0, 1)

scenario <- rep(c("A", "B"), each = 10)

toy_dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(toy_dataset) <- c("PatientID", "Followup", "Eventtype", "Scenario")

for (value in unique(toy_dataset$Scenario)){
  print(tail((toy_dataset[toy_dataset$Scenario == value,]),2))
}

# small offset otherwise curves would almost fully overlap.
toy_dataset$Followup = ifelse(toy_dataset$Scenario == "A", toy_dataset$Followup + 0.07, toy_dataset$Followup + 0)

```

---

```{r basicplot3, ref.label='basicplot', warning=F, echo=F, message=F}
```
