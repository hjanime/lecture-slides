---
title: 生物统计原理
subtitle: 生存分析
author: "王强"
institute: "南京大学生命科学学院"
date: \today{}
toc: true

---

```{r setup, include=FALSE}
# load packages
library(knitr)
library(tidyverse)
library(lubridate)
library(survival)
library(survminer)
library(randomNames)

# set output options
knitr::opts_chunk$set(fig.width = 4, fig.height = 4, dpi=300)
options(digits = 4)
```

```{bash compile, include=FALSE}
# Rscript -e "library(knitr); knitr::knit('biostat-survival.rmd');"
# make biostat-survival

# Rscript -e "library(randomNames); randomNames(10, ethnicity=5, which.names='first', sample.with.replacement=F);"

```

# 生存分析

## 定义

生存分析
: 是统计学的分支，用于分析一个或多个\alert{事件}发生前的预期持续\alert{时间} (Survival analysis).

\smallskip

事件
: 死亡、疾病发生、疾病复发、疾病进展或机械系统故障等 (Event).

\smallskip

时间
: 从观察期开始 (如手术或开始治疗) 到 1) 事件发生、2) 研究结束、3) 失去联系或退出研究 的时间 (Time).

\note{

生存分析试图回答以下问题：

将在一定时间后生存的人口比例是多少？

在那些幸存者中，他们将以何种速度死亡或失败？

可以考虑多种死亡或失败原因吗？

特定情况或特征如何增加或降低生存概率？

事件可以是非常明确的, 例如死亡; 但也可能有些模糊, 心肌梗死, 器官衰竭等

对于机械系统, 故障可能无法明确定义

}

---

* 工程学 - 可靠性分析
* 经济学 - 持续时间分析
* 社会学 - 事件历史分析
* Time-to-Event (TTE) Analysis

## 数据

对于癌症

* 总生存 (Overall survival, OS)
  * Time from surgery to death
* 无进展生存 (Progression-free survival, PFS)
  * Time from start of treatment to progression
  * Time from response to recurrence

## 分析方法

* 描述生存时间

  * Kaplan--Meier 曲线
  * 生存函数
  * 生命表

* 比较生存时间

  * 秩和检验

* 变量对生存的影响

  * Cox 比例风险回归

\note{

保险公司里精算师 生命表（也称死亡率表或精算表）

}

# Kaplan--Meier curve

## Basic Kaplan--Meier curve

```{r basic, warning=F, echo=F, message=F, comment=NA}
followup <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
eventtype <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1)

patientID <- c("Sarah", "Joel", "James", "Daniel", "Eric", "Kaitlynn", "Kelly", "Morgen", "Brandie", "Luke" )
scenario <- c("A", "A", "A", "A", "A", "A", "A", "A", "A", "A")

dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(dataset) <- c("PatientID", "FollowUp", "EventType", "Scenario")

kable(dataset)

```

\note{

从创建一些简单的数据开始

10 个高加索人种的病人, 10 个月的随访数据, 对所有参与者, 同样的治疗手段

If we take a closer look at the 'Follow-up' and 'Eventtype' columns:

* Event type of 1 equals an event (for example death in an overall survival study)
* Event type of 0 equals a right-censored event.

In this first example, there are no censored events.

}

---

随访
: Follow up, 可以用任何时间间隔, 天、月、年

事件类型
: Event type,　`1` 表示事件发生, 在 Overall Survival 里, 代表死亡

分层
: Strata, Scenario, 可以是类别变量, 也可以是连续变量

拟合
: Fit

\note{

事件类型不为 1 的, 后面讲

Strata

英  ˈstrɑːtə   美  ˈstreɪtə

男/女, 给药/安慰剂, 高/低分险 等

Note that in this simulation we are showing multiple scenarios, so we are fitting to
`Scenario`, but this can also be for example a treatment column.

}

---

```{.r .numberLines}
# The R package `survival`
library(survival)

# Define what the time column is dataset$FollowUp
#   and the event column is dataset$EventType
surv_object <- Surv(
    time = dataset$FollowUp,
    event = dataset$EventType
)

# Fit the Kaplan--Meier curve to this data `Scenario`
fit <- survfit(
    surv_object ~ Scenario,
    data = dataset
)
```

---

```{r km_code, warning=F, echo=F, message=F}
surv_object <- Surv(time = dataset$FollowUp , event = dataset$EventType)
fit <- survfit(surv_object ~ Scenario, data = dataset)
j <- ggsurvplot(
    fit,
    data = dataset,
    conf.int = FALSE,
    censor.shape = "|",
    censor.size = 3,
    ggtheme = theme_bw()
)

```

```{r km_plot, fig.cap = 'KM - basic', warning=F, echo=F, message=F}
j$plot <- j$plot +
    theme(aspect.ratio=1) +
    theme(panel.grid.major.x = element_blank(), panel.grid.major.y = element_blank()) +
    theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank()) +
    scale_x_continuous(limits = c(0,10), breaks = sort(c(seq(0, 10, 1)))) +
    scale_y_continuous(limits = c(0,1), breaks = seq(0, 1, 0.2), expand = c(0.02,0.02)) +
    theme(legend.background = element_rect(colour = "transparent", fill = "transparent")) +
    theme(legend.justification=c(1,1), legend.position=c(1,1), legend.direction = "vertical") +
    theme(legend.title = element_blank())

j$plot

```

\note{

Every month, 1 participant has an event (in an overall survival study this would be death).

Every time an event occurs, the survival probability drops by 0.1 of the remaining curve
(= events / at risk = 1/10 of the remaining curve at month 1,
1/9 of the remaining curve at month 2 and so on)

}

## Kaplan--Meier curve with censored data

```{r censor, warning=F, echo=F, message=F, comment=NA}
followup <- c(1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10)
eventtype <- c(1, 1,  0, 0, 1, 1, 1, 0, 1, 0)

dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(dataset) <- c("PatientID", "FollowUp", "EventType", "Scenario")

kable(dataset)

```

---

```{r, ref.label='km_code', warning=F, echo=F, message=F}
```

```{r km_censored, fig.cap = 'KM - censored', ref.label='km_plot', warning=F, echo=F, message=F}
```

---

时间
: 从观察期开始到 1) 事件发生、2) 研究结束、3) 失去联系或退出研究 的时间 (Time).

\smallskip

删失

: 如果一个主体在观察时间内没有发生\underline{事件}, 则被描述为被删失 (Censored/Censoring). 删失之后,
不了解该主体的信息, 它可能发生也可能不发生事件.

\note {

需要对应回我们对于时间的定义来理解这个概念

这是我最不习惯的翻译之一, 也有译为 截断

对于删失数据, 我们只知道该主体没有发生事件的时间长度

censor 检查员

imperil censor 御史

censorship 查禁

censored 被和谐

}

---

```{r swimmer, fig.cap = 'Censored data', warning=F, echo=F, message=F}
# make fake data
set.seed(202004016)
fkdt <- tibble(
    Subject = as.factor(1:10),
    Months = sample(12:72, 10, replace = T)
)
fkdt$censor <- sample(c("Censored", rep("Event", 2)), 10, replace = T)
for (i in 1:10) {
    if (fkdt$Months[i] > 60) {
        fkdt$censor[i] <- "Censored"
    }
}

# plot with shapes to indicate censoring or event
j <- ggplot(fkdt, aes(Subject, Months)) +
    geom_bar(stat = "identity", width = 0.2) +
    geom_point(data = fkdt,
               aes(Subject, Months, color = censor, shape = censor),
               size = 4) +
    geom_hline(yintercept = 60, color="orange", size=1) +
    coord_flip() +
    theme_minimal() +
    theme(legend.title = element_blank(), legend.position = "bottom")

j

```

\note{

观察期 5 年时间

右删失, 左删失; 具体的意义可以暂时不管


In this example, how would we compute the proportion who are event-free at 10 years?

Subjects 2, 3, 5, 6, 8, 9, and 10 were all **event-free at 10 years**. Subjects 4 and 7 had the
**event before 10 years**. Subject 1 was **censored before 10 years**, so we don't know whether they
had the event or not by 10 years - how do we incorporate this subject into our estimate?

}

## Remove censored data?

感觉删失数据用处不大, 把它们去掉行不行?

---

```{r Actual, results='markup', warning=F, echo=F, message=F, comment=NA}
followup <- c(
    1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10,
    1, 2, 10, 10, 5, 6, 6.2, 10, 10, 10,
    1, 2, 2, 2, 5, 6, 6.2, 9, 9, 10
)
eventtype <- c(
    1, 1, 0, 0, 1, 1, 1, 0, 1, 0,
    1, 1, 0, 0, 1, 1, 1, 0, 1, 0,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1
)

scenario <- rep(c("Actual", "Best", "Worst"), each = 10)

dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(dataset) <- c("PatientID", "FollowUp", "EventType", "Scenario")

kable(dataset[dataset$Scenario == "Actual",], row.names = F)

```

\note{

We can simulate the best case scenario (all censoring = no events) and the worst case scenario (all
censoring = events) and compare this to the actual curve (scroll through the data sheet to see the
differences).

}

---

```{r Best, results='markup', warning=F, echo=F, message=F, comment=NA}
kable(dataset[dataset$Scenario == "Best",], row.names = F)

```

---

```{r Worst, results='markup', warning=F, echo=F, message=F, comment=NA}
kable(dataset[dataset$Scenario == "Worst",], row.names = F)

```

---

```{r best_worst, warning=F, echo=F, message=F}
surv_object <- Surv(time = dataset$FollowUp, event = dataset$EventType)

fit <- survfit(surv_object ~ Scenario, data = dataset)

j <- ggsurvplot(fit,
    data = dataset,
    conf.int = FALSE,
    censor.shape = "|",
    censor.size = 3,
    surv.median.line = c("hv"),
    ggtheme = theme_bw()
)

```

```{r km_best_worst, fig.cap = 'KM - actual/best/worst', ref.label='km_plot', warning=F, echo=F, message=F}
```

\note{

In the best case scenario, the curve stops at 0.5 at the end of the study, while in the worst case
scenario the curve drops to 0. The median survival times are also very different:

* Actual curve: 6.2 months

* Best case: 8.1 months

* Worst case: 5.5 months

}

## Importance of confidence intervals

```{r scenario, results='asis', warning=F, echo=F, message=F, comment=NA}
followup <- c(
    1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10,
    1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10
)
eventtype <- c(
    1, 1, 0, 0, 1, 1, 1, 0, 1, 0,
    1, 1, 0, 0, 1, 1, 1, 0, 0, 1
)

scenario <- rep(c("A", "B"), each = 10)

dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(dataset) <- c("PatientID", "FollowUp", "EventType", "Scenario")

for (value in unique(dataset$Scenario)){
    print(kable(tail((dataset[dataset$Scenario == value,]),2), row.names = F))
    cat('\n\n')
}

# small offset otherwise curves would almost fully overlap.
dataset$FollowUp = ifelse(dataset$Scenario == "A", dataset$FollowUp - 0.1, dataset$FollowUp + 0)

```

\note{

Especially when there are very few patients at risk, the impact of a censored event can have a big
impact on the appearance of the KM curve.

In the previous plot, it seems that the survival curve reaches a plateau at 0.2 surival probability
(curve A). If we would swap the censored status between Joe and Kate (participants 9 and 10), the KM
curve changes drastically and drops to 0 at the end of the study period. In this scenario (curve B),
all participants either had an event or were censored.

}

---

```{r, ref.label='km_code', warning=F, echo=F, message=F}
```

```{r km_scenario, fig.cap = 'KM - scenarios', ref.label='km_plot', warning=F, echo=F, message=F}
```

\note{

In other words, only one events marks the difference between the survival curve reaching 0 or
reaching a plateau staying stable at 0.2.

}

---


```{r ci, warning=F, echo=F, message=F, comment=NA}
dataset <- subset(dataset, Scenario == "A")

surv_object <- Surv(time = dataset$FollowUp, event = dataset$EventType)

fit <- survfit(surv_object ~ Scenario, data = dataset)

j <- ggsurvplot(fit,
    data = dataset,
    conf.int = TRUE,
    censor.shape = "|",
    censor.size = 3,
    ggtheme = theme_bw()
)

```

```{r km_ci, fig.cap = 'KM - CI', ref.label='km_plot', warning=F, echo=F, message=F}
```

\note{

We can also see this is if we plot the 95% confidence intervals on the KM curve. The confidence
intervals are very wide, giving a clue that the study contains very few participants:

}

## Conclusions

* Censored data can substantially affect the KM curve, but have to be included when fitting the
  curve.
* Show censored data on the curve as much as possible.
* Be cautious when interpreting the end of the KM if there are big drops present.
* The height of the drop can inform you about the number of patients at risk, even when it’s not
  reported or when there are no confidence intervals shown.
