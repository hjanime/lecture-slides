---
title: 生物统计原理
subtitle: 生存分析
author: "王强"
institute: "南京大学生命科学学院"
date: \today{}
toc: true

---

```{r setup, include=FALSE}
# load packages
library(knitr)
library(tidyverse)
library(survival)
library(survminer)
library(randomNames)

options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)

# set output options
knitr::opts_chunk$set(fig.width = 4, fig.height = 4, dpi=300)
options(digits = 4)

km_mod <- function(plot) {
    plot <- plot +
        theme(aspect.ratio=1) +
        theme(panel.grid.major.x = element_blank(), panel.grid.major.y = element_blank()) +
        theme(panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank()) +
        scale_y_continuous(limits = c(0,1), breaks = seq(0, 1, 0.2), expand = c(0.02,0.02)) +
        theme(legend.background = element_rect(colour = "transparent", fill = "transparent")) +
        theme(legend.justification=c(1,1), legend.position=c(1,1), legend.direction = "vertical") +
        theme(legend.title = element_blank())

    plot
}

km_mod_60 <- function(plot) {
    plot <- km_mod(plot)
    plot <- plot +
        scale_x_continuous(limits = c(0,60), breaks = sort(c(seq(0, 60, 6))))

    plot
}

```

```{bash compile, include=FALSE}
# Rscript -e "library(knitr); knitr::knit('biostat-survival.rmd');"
# make biostat-survival.slides.pdf

# Rscript -e "library(randomNames); randomNames(10, ethnicity=5, which.names='first', sample.with.replacement=F);"

```

# 生存分析

## 定义

生存分析
: 是统计学的分支, 用于分析一个或多个\alert{事件}发生前的预期持续\alert{时间} (Survival analysis).

\smallskip

事件
: 死亡、疾病发生、疾病复发、疾病进展或机械系统故障等 (Event).

\smallskip

时间
: 从观察期开始 (如手术或开始治疗) 到 1) 事件发生、2) 研究结束、3) 失去联系或退出研究 的时间 (Time).

\note{

生存分析试图回答以下问题：

将在一定时间后生存的人口比例是多少？

在那些幸存者中, 他们将以何种速度死亡或失败？

可以考虑多种死亡或失败原因吗？

特定情况或特征如何增加或降低生存概率？

事件可以是非常明确的, 例如死亡; 但也可能有些模糊, 心肌梗死, 器官衰竭等

对于机械系统, 故障可能无法明确定义

}

---

* 工程学 - 可靠性分析
* 经济学 - 持续时间分析
* 社会学 - 事件历史分析
* Time-to-Event (TTE) Analysis

## 数据

对于癌症

* 总生存 (Overall survival, OS)
  * Time from surgery to death
* 无进展生存 (Progression-free survival, PFS)
  * Time from start of treatment to progression
  * Time from response to recurrence

## 分析方法

* 描述生存时间

  * Kaplan--Meier 曲线
  * 生存函数
  * 生命表

* 比较生存时间

  * 秩和检验

* 变量对生存的影响

  * Cox 比例风险回归

\note{

这是今天讲的内容的大纲, 重点讲 KM 曲线 和 Cox 回归

生存函数, 生命表 和 秩和检验 会对照着实例略讲一下

}

# Kaplan--Meier curve

## Basic Kaplan--Meier curve

```{r basic, warning=F, echo=F, message=F, comment=NA}
followup <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10) * 6
eventtype <- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1)

patientID <- c("Sarah", "Joel", "James", "Daniel", "Eric", "Kaitlynn", "Kelly", "Morgen", "Brandie", "Luke" )
scenario <- c("A", "A", "A", "A", "A", "A", "A", "A", "A", "A")

dataset <- tibble(
    PatientID = patientID,
    FollowUp = followup,
    EventType = eventtype,
    Scenario = scenario
)

kable(dataset, "markdown")

```

\note{

从创建一些简单的数据开始

10 个高加索人种的病人, 10 个月的随访数据, 对所有参与者, 同样的治疗手段

If we take a closer look at the 'Follow-up' and 'Eventtype' columns:

* Event type of 1 equals an event (for example death in an overall survival study)
* Event type of 0 equals a right-censored event.

In this first example, there are no censored events.

}

---

随访
: Follow up, 可以用任何时间间隔, 天、月、年

事件类型
: Event type,　`1` 表示事件发生, 在 Overall Survival 里, 代表死亡

分层
: Strata, Scenario, 类别变量, 也可以是分组后的连续变量

拟合
: Fit

\note{

事件类型不为 1 的, 后面讲

Strata

英  ˈstrɑːtə   美  ˈstreɪtə

男/女, 给药/安慰剂, 高/低分险 等

Note that in this simulation we are showing multiple scenarios, so we are fitting to
`Scenario`, but this can also be for example a treatment column.

}

## R 代码 {.allowframebreaks}

```{.r .numberLines}
# R packages
library(tidyverse)
library(survival)

# Init data
dataset <- tibble(
    PatientID = c("Sarah", "Joel", "James", "Daniel", "Eric", "Kaitlynn", "Kelly", "Morgen", "Brandie", "Luke"),
    FollowUp  = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10) * 6,
    EventType = c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
    Scenario  = c("A", "A", "A", "A", "A", "A", "A", "A", "A", "A")
)
# dataset <- read_tsv("basic.tsv")

# Define what the time column is dataset$FollowUp
#   and the event column is dataset$EventType
surv_object <- Surv(
    time  = dataset$FollowUp,
    event = dataset$EventType
)

# Fit the Kaplan--Meier curve to this data `Scenario`
fit <- survfit(
    surv_object ~ Scenario,
    data = dataset
)
```

\note{

R 里用 packages (包) 这个词, 其它语言里经常也用 modules (模块), libraries (库) 之类的.

它们是都是包装好的, 完成特定任务的功能性程序组合.

tidyverse 是现代 R 程序处理数据的事实标准

survival 是生存分析最常用的, 也是最全面的包. 也可以在 SPSS 里完成今天我们所说的所有分析

}

---

```{r km_code, warning=F, echo=F, message=F}
surv_object <- Surv(time = dataset$FollowUp, event = dataset$EventType)
fit <- survfit(surv_object ~ Scenario, data = dataset)
j <- ggsurvplot(
    fit,
    data = dataset,
    conf.int = FALSE,
    censor.shape = "|",
    censor.size = 3,
    ggtheme = theme_bw()
)

```

```{r km_basic, fig.cap = 'KM - basic', warning=F, echo=F, message=F}
km_mod_60(j$plot)
```

\note{

Every month, 1 participant has an event (in an overall survival study this would be death).

Every time an event occurs, the survival probability drops by 0.1 of the remaining curve
(= events / at risk = 1/10 of the remaining curve at month 1,
1/9 of the remaining curve at month 2 and so on)

}

## Kaplan--Meier curve with censored data

```{r censor, warning=F, echo=F, message=F, comment=NA}
followup <- c(1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10) * 6
eventtype <- c(1, 1,  0, 0, 1, 1, 1, 0, 1, 0)

dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(dataset) <- c("PatientID", "FollowUp", "EventType", "Scenario")

kable(dataset, "markdown")

```

---

```{r, ref.label='km_code', warning=F, echo=F, message=F}
```

```{r km_censored, fig.cap = 'KM - censored', warning=F, echo=F, message=F}
km_mod_60(j$plot)
```

---

时间
: 从观察期开始到 1) 事件发生、2) 研究结束、3) 失去联系或退出研究 的时间 (Time).

\smallskip

删失

: 如果一个受试者在观察时间内没有发生\underline{事件}, 则被描述为被删失 (Censored/Censoring). 删失之后,
不观察或不了解该受试者的信息, 它可能发生也可能不发生事件.

\note {

需要对应回我们对于时间的定义来理解这个概念

这是我最不习惯的翻译之一, 也有译为 截断

对于删失数据, 我们只知道该受试者没有发生事件的时间长度

censor 检查员

imperil censor 御史

censorship 查禁, 省察

censored 被和谐

}

## Remove censored data?

感觉删失数据用处不大/不可靠/破坏完整性, 把它们去掉行不行?

---

```{r Actual, results='markup', warning=F, echo=F, message=F, comment=NA}
followup <- c(
    1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10,
    1, 2, 10, 10, 5, 6, 6.2, 10, 10, 10,
    1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10
) * 6
eventtype <- c(
    1, 1, 0, 0, 1, 1, 1, 0, 1, 0,
    1, 1, 0, 0, 1, 1, 1, 0, 1, 0,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1
)

scenario <- rep(c("Actual", "Best", "Worst"), each = 10)

dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(dataset) <- c("PatientID", "FollowUp", "EventType", "Scenario")

kable(dataset[dataset$Scenario == "Actual",], "markdown", row.names = F)

```

\note{

We can simulate the best case scenario (all censoring = no events) and the worst case scenario (all
censoring = events) and compare this to the actual curve.

}

---

```{r Best, results='markup', warning=F, echo=F, message=F, comment=NA}
kable(dataset[dataset$Scenario == "Best",], "markdown", row.names = F)
```

---

```{r Worst, results='markup', warning=F, echo=F, message=F, comment=NA}
kable(dataset[dataset$Scenario == "Worst",], "markdown", row.names = F)
```

---

```{r best_worst, warning=F, echo=F, message=F}
# small offset otherwise curves would almost fully overlap.
dataset$FollowUp = ifelse(dataset$Scenario == "Actual", dataset$FollowUp - 0.6, dataset$FollowUp + 0)
dataset$FollowUp = ifelse(dataset$Scenario == "Worst", dataset$FollowUp - 1.2, dataset$FollowUp + 0)

surv_object <- Surv(time = dataset$FollowUp, event = dataset$EventType)

fit <- survfit(surv_object ~ Scenario, data = dataset)

j <- ggsurvplot(fit,
    data = dataset,
    conf.int = FALSE,
    censor.shape = "|",
    censor.size = 3,
    surv.median.line = c("hv"),
    ggtheme = theme_bw()
)

```

```{r km_best_worst, fig.cap = 'KM - actual/best/worst', warning=F, echo=F, message=F}
km_mod_60(j$plot)
```

\note{

In the best case scenario, the curve stops at 0.5 at the end of the study, while in the worst case
scenario the curve drops to 0. The median survival times are also very different:

* Actual curve: 6.2 months

* Best case: 8.1 months

* Worst case: 5.5 months

}

## Importance of confidence intervals

```{r scenario, results='asis', warning=F, echo=F, message=F, comment=NA}
followup <- c(
    1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10,
    1, 2, 3, 4, 5, 6, 6.2, 8, 9, 10
) * 6
eventtype <- c(
    1, 1, 0, 0, 1, 1, 1, 0, 1, 0,
    1, 1, 0, 0, 1, 1, 1, 0, 0, 1
)

scenario <- rep(c("A", "B"), each = 10)

dataset <- data.frame(patientID, followup, eventtype, scenario)
colnames(dataset) <- c("PatientID", "FollowUp", "EventType", "Scenario")

for (value in unique(dataset$Scenario)){
    print(kable(tail((dataset[dataset$Scenario == value,]),2), "markdown", row.names = F))
    cat('\n\n')
}

# small offset otherwise curves would almost fully overlap.
dataset$FollowUp = ifelse(dataset$Scenario == "A", dataset$FollowUp - 0.6, dataset$FollowUp + 0)

```

\note{

Especially when there are very few patients at risk, the impact of a censored event can have a big
impact on the appearance of the KM curve.

In the previous plot, it seems that the survival curve reaches a plateau at 0.2 surival probability
(curve A). If we would swap the censored status between Joe and Kate (participants 9 and 10), the KM
curve changes drastically and drops to 0 at the end of the study period. In this scenario (curve B),
all participants either had an event or were censored.

}

---

```{r, ref.label='km_code', warning=F, echo=F, message=F}
```

```{r km_scenario, fig.cap = 'KM - scenarios', warning=F, echo=F, message=F}
km_mod_60(j$plot)
```

\note{

In other words, only one events marks the difference between the survival curve reaching 0 or
reaching a plateau staying stable at 0.2.

}

---


```{r ci, warning=F, echo=F, message=F, comment=NA}
dataset <- subset(dataset, Scenario == "A")

surv_object <- Surv(time = dataset$FollowUp, event = dataset$EventType)

fit <- survfit(surv_object ~ Scenario, data = dataset)

j <- ggsurvplot(fit,
    data = dataset,
    conf.int = TRUE,
    censor.shape = "|",
    censor.size = 3,
    ggtheme = theme_bw()
)

```

```{r km_ci, fig.cap = 'KM - CI', warning=F, echo=F, message=F}
km_mod_60(j$plot)
```

\note{

We can also see this is if we plot the 95% confidence intervals on the KM curve. The confidence
intervals are very wide, giving a clue that the study contains very few participants:

}

# 生存函数

---

受试者在任何指定的时间内存活下来的概率

$$S(t)=Pr(\{T>t\})=\int _{t}^{\infty }f(u)\,du=1-F(t)$$

$S(t)$: 生存函数

$F(t) = Pr(\{T \leq t\})$: 累计分布函数

\note{

看起来有点复杂, 直接看用法就好

}

---

\begin{columns}[T,onlytextwidth]
    \column{0.5\textwidth}
        \includegraphics{biostat-survival.images/Survival_function_1.svg.png}
    \column{0.5\textwidth}
        \includegraphics{biostat-survival.images/Survival_function_2.svg.png}
\end{columns}

\note{

在理论上, 生存函数是平滑的；在实践中, 我们在离散时间尺度上观察事件, 通常用 KM 曲线来估计.

第一个生存率明显比第二个要低

For example, for survival function 1, the probability of surviving longer than t = 2 months is 0.37.
That is, 37% of subjects survive more than 2 months.

For survival function 2, the probability of surviving longer than t = 2 months is 0.97. That is, 97%
of subjects survive more than 2 months.

}

---

\begin{columns}[T,onlytextwidth]
    \column{0.5\textwidth}
        \includegraphics{biostat-survival.images/Survival_function_2_median_survival.svg.png}
    \column{0.5\textwidth}
        \includegraphics{biostat-survival.images/Median_survival_greater_than_10_months.svg.png}
\end{columns}

\note{

Median survival may be determined from the survival function. For example, for survival function 2,
50% of the subjects survive 3.72 months. Median survival is thus 3.72 months.

In some cases, median survival cannot be determined from the graph. For example, for survival
function 4, more than 50% of the subjects survive longer than the observation period of 10 months.

The Kaplan--Meier method is the most common way to estimate survival times and probabilities.

}

# 现实数据

---

对于一个受试者 $i$:

1. 事件时间 $T_i$
2. 删失时间 $C_i$
3. 事件指标 $\delta_i$:

    * 如果事件发生, `1` (i.e. $T_i \leq C_i$)
    * 如果删失, `0` (i.e. $T_i > C_i$)

4. 观察时间 $Y_i = \min(T_i, C_i)$

像前面强调的, \underline{事件} 与 \underline{时间} 是最重要的, 其它的数据项基本都是用来分组的.


\note{

事件发生在第 72 个月, 而观察区间设成 60 个月, 那就是一个 60 个月的删失时间

}

---

```{r swimmer, fig.cap = 'Censored data', warning=F, echo=F, message=F}
# make fake data
set.seed(202004016)
fkdt <- tibble(
    Subject = as.factor(1:10),
    Months = sample(12:72, 10, replace = T)
)
fkdt$censor <- sample(c("Censored", rep("Event", 2)), 10, replace = T)
for (i in 1:10) {
    if (fkdt$Months[i] > 60) {
        fkdt$censor[i] <- "Censored"
    }
}

# plot with shapes to indicate censoring or event
j <- ggplot(fkdt, aes(Subject, Months)) +
    geom_bar(stat = "identity", width = 0.2) +
    geom_point(data = fkdt,
               aes(Subject, Months, color = censor, shape = censor),
               size = 4) +
    geom_hline(yintercept = 60, color="orange", size=1) +
    coord_flip() +
    theme_minimal() +
    theme(legend.title = element_blank(), legend.position = "bottom")

j

```

\note{

观察期 5 年时间

右删失, 左删失; 具体的意义可以暂时不管

事件发生在第 72 个月, 而观察区间设成 60 个月, 那就是一个 60 个月的删失时间


In this example, how would we compute the proportion who are event-free at 10 years?

Subjects 2, 3, 5, 6, 8, 9, and 10 were all **event-free at 10 years**. Subjects 4 and 7 had the
**event before 10 years**. Subject 1 was **censored before 10 years**, so we don't know whether they
had the event or not by 10 years - how do we incorporate this subject into our estimate?

}

## `aml`

```{r viewaml, results='asis', warning=F, echo=F, message=F}
aml %>%
    mutate(ID = row_number()) %>%
    select(ID, everything()) %>%
    arrange(time) %>%
    kable(format="latex", booktabs=T, linesep="") %>%
    kable_styling(font_size = 5)
```

\note{

以 `survival` 包里的 `aml` 和 `lung` 数据为例

AML - 急性髓细胞白血病

Time 是生存或删失时间

Event 是 AML 复发

Treatment group: the variable "x" indicates if maintenance chemotherapy was given

最后一位受试者 11, 在 161 周时删失, 剔除表示该患者没有发生事件, 即没有 AML 复发.

另一个受试者 3 号, 在 13 周时删失 (状态=0). 这名受试者只在研究中呆了 13 周, 而在这13周内, aml 没有复发.
这名患者有可能是在研究接近尾声时入组的, 所以只观察了13周. 也有可能是这名患者在研究早期入组,
但在研究中失去了随访或退出研究. 从表中可以看出, 其他受试者在16周、28周和45周时删失 (17、6、9的状态=0).

其余受试者在研究期间都经历了事件, AML 复发.

}

---

```{r aml_km, fig.cap = 'Censored data', warning=F, echo=F, message=F}
fit <- survfit(Surv(time = aml$time, event = aml$status) ~ 1, data = aml)

j <- ggsurvplot(
    fit,
    data = aml,
    conf.int = T,
    xlab = "Days",
    censor.shape = "|",
    censor.size = 3,
    ggtheme = theme_bw()
)

km_mod(j$plot)
```

\note{

这个就是生存函数

我们感兴趣的问题是, 与非维持性患者相比, 维持性患者的复发发生时间是否比非维持性患者晚.

}

---

```{r aml_km_x, fig.cap = 'Censored data', warning=F, echo=F, message=F}
fit <- survfit(Surv(time = aml$time, event = aml$status) ~ aml$x, data = aml)

j <- ggsurvplot(
    fit,
    data = aml,
    conf.int = T,
    xlab = "Days",
    censor.shape = "|",
    censor.size = 3,
    ggtheme = theme_bw()
)

km_mod(j$plot)
```

\note{

置信区间重叠这么大, 两组间有差异吗? 显著吗?

}

## 秩和检验

CMH Logrank test.

建立在二项数据的标准方法的基础上, 在每个不同的死亡时间构建一个 2x2 的表，并比较两组之间的死亡率与风险人数, 然后用
Cochran--Mantel--Haenszel 检验将这些表格合并. 有时也被叫作 Mantel--Cox 检验.

```{r aml_diff, result='asis', warning=F, echo=T, message=F}
diff <- survdiff(
    Surv(time=aml$time, event=aml$status) ~ aml$x,
    rho=0
)

pchisq(diff$chisq, length(diff$n)-1, lower.tail=F)
```

## 生命表

生命表
: 是指每一个年龄段的人在下一个生日前死亡的概率 (Life table).

\note{

AML 的数据比较简单, 我们用它来介绍另一个概念

保险公司里精算师, 生命表 (也称死亡率表或精算表)

死亡是一种事件, 我们也可以把它换成其它类型的事件, 这里就 AML 的数据来说, 换成 AML 复发事件.

}

---

\begin{longtable}[]{@{}lrrl@{}}
    \caption{John Graunt's Life Table (1662)} \\
    \toprule
    Age Interval & Proportion Deaths & Proportion Surviving until\tabularnewline
    & in Interval & start of Interval\tabularnewline
    \midrule
    \endhead
    0--6   & 0.36 & 1.00 \tabularnewline
    7--16  & 0.24 & 0.64 \tabularnewline
    17--26 & 0.15 & 0.40 \tabularnewline
    27--36 & 0.09 & 0.25 \tabularnewline
    37--46 & 0.06 & 0.16 \tabularnewline
    47--56 & 0.04 & 0.10 \tabularnewline
    57--66 & 0.03 & 0.06 \tabularnewline
    67--76 & 0.02 & 0.03 \tabularnewline
    77--86 & 0.01 & 0.01 \tabularnewline
    \bottomrule
\end{longtable}

\note{

约翰·葛兰特是一位英国经济学家, 也是第一位从事人口统计学调查的研究者；根据同业描述, 他原本是位服饰经销商.

他的著作《对死亡率表的自然与政治观察》 (Natural and Political Observations Made upon the Bills of
Mortality) 发表于格里历1663年或儒略历1662年, 分析查理二世时期伦敦地区死亡率的起伏, 研究腺鼠疫的开始与扩散的系统性方法,
并发出警告. 虽然这个方法并未真正发明出来, 但他的著作仍被用以判断当时的伦敦人口数目.

葛兰特的表现使他带着著作前往英国皇家学会, 参与院士选举,
有些院士却不乐见一位服饰经销商成为他们的同僚. 但英国国王查理二世仍独排众议, 让葛兰特进入皇家学会.

}

---

![Life table for `aml`](biostat-survival.images/Life_table_for_the_aml_data.png)

## `lung`

```{r viewlung, results='asis', warning=F, echo=F, message=F}
kable(head(lung), "latex", booktabs=T, linesep = "") %>%
    kable_styling(latex_options =c("scale_down"))
```

`R` 的 `Surv` 函数可以接受三种指标样式

1. `1/0` (`1` = event)
2. `1/2` (`2` = event)
3. `TRUE/FALSE` (`TRUE` = event)

\note{

以前只有这么几个指标, 统计学家玩出花儿来, 也得不到什么有用的东西.

现在我们有了几十万个表观遗传位点, 直接用暴力穷举, 找到最好的指标组合.

NCCTG Lung Cancer Data

inst:       Institution code

time:	Survival time in days ($Y_i$)

status:	censoring status 1=censored, 2=dead ($\delta_i$)

age:        Age in years

sex:        Male=1 Female=2

ph.ecog:    ECOG performance score (0=good 5=dead)

ph.karno:   Karnofsky performance score (bad=0-good=100) rated by physician

pat.karno:  Karnofsky performance score as rated by patient

meal.cal:   Calories consumed at meals

wt.loss:    Weight loss in last six months

The use of 1/2 for alive/dead instead of the usual 0/1 is a historical footnote. For data contained
on punch cards, IBM 360 Fortran treated blank as a zero, which led to a policy within the section of
Biostatistics to never use "0" as a data value since one could not distinguish it from a missing
value. The policy became a habit, as is often the case; and the 1/2 coding endured long beyond the
demise of punch cards and Fortran.

}

---

```{r fuptimes, fig.cap = 'Distribution of follow-up time', warning=F, echo=F, message=F}
j <- ggplot(lung, aes(x = time, fill = factor(status))) +
    geom_histogram(bins = 25, alpha = 0.6, position = "identity") +
    scale_fill_manual(values = c("blue", "red"), labels = c("Censored", "Dead")) +
    labs(x = "Days", y = "Count") +
    theme_minimal()

j
```

\note{

- Censored subjects still provide information so must be appropriately included in the analysis

- Distribution of follow-up times is skewed, and may differ between censored patients and those with
  events

- Follow-up times are always positive

}

## Conclusions

* Censored data can substantially affect the KM curve, but have to be included when fitting the
  curve.
* Show censored data on the curve as much as possible.
* Be cautious when interpreting the end of the KM if there are big drops present.
* The height of the drop can inform you about the number of patients at risk, even when it’s not
  reported or when there are no confidence intervals shown.
